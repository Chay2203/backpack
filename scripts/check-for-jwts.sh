#!/usr/bin/env sh

# Contains JWTs hardcoded in the repository for dev and testing purposes
ALLOWLIST=(
  "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwczovL2hhc3VyYS5pby9qd3QvY2xhaW1zIjp7IngtaGFzdXJhLWFsbG93ZWQtcm9sZXMiOlsiaW52aXRlc193b3JrZXIiXSwieC1oYXN1cmEtZGVmYXVsdC1yb2xlIjoiaW52aXRlc193b3JrZXIifSwiaWF0IjoxNjY0MjQ3NzQzfQ.VQY5NqNWN9eM3ROkgWMwfzc9dv6nXoCKv57HnUWQLC4QrZbzExLZb3wMVVtpPfkHpHWzzKrCVuBPvhC7W6pbv3OYgNNvwoS5B2XxZeONecs4T47Hqn7ULk2dYdtMwPEGjFnXodYikbAFR8GDhKFvn_s65fwLtbftL7FZrzC550tCCNnkVE3q3kPlkHTWqQe5NTHcDLZzg97n0bM2fvU5ZV-5x0u_SPSBEs60gqlDk8OclwUu2j71iA0UGr4M4EBvpjgoUgY7KFyGWgRjgWgrsJa7JBo97V97rp6KTahcFtMAC4AZOOOIfuyR3ehrDdYcW0-xPWP7a49uGg6lyDD8KhDC6UURUurnI7g2BN-1Ua9R90MiwvuCoPfzdCDbwR6Z7IEcXZiVKKd7qDQU4FjMgLAlH2s445p43X2WpeyXQ33nN2wy5TEBEt9w95HpitkZCq3MGv3uH7qbKw3og2wDb0r2r4xrCwpqfWtf70_JYULfddmI5q_SB9aQrC5HcfyNYgPwDD_Vx8F43_azBiy3CZ2A0nt9TU3bnpfi9echdL06OsLA2iWT2Z5_xPkyQW5Ke2GGc21ZnnFt1k9nLdfXZV8sYh_xBQPcYlOHBY9OTwczkSXY7KUekUIMaDPZOzexrb9DWNn3yBkm4buatKftLwA2W8sz9OBFN2fG9GAfKds"
  "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwczovL2hhc3VyYS5pby9qd3QvY2xhaW1zIjp7IngtaGFzdXJhLWFsbG93ZWQtcm9sZXMiOlsiY2hhdCJdLCJ4LWhhc3VyYS1kZWZhdWx0LXJvbGUiOiJjaGF0In0sImlhdCI6MTY3MDg2NzkwN30.LI0YdKWnuCnRoJWsatcRclcruL1ojtYN7R6-zWNnpoCEz8N5pgBKaOOFFTGvcvwkG3ALo-eAAwELrBOEEVAUR7rxd5bq23rPX3eh0pkHZ0i0fLHm1o3BOcv4J_dXT2RBwcG1Y9E335L2M-N0WqlQa4Y3XnZiRkUGe0WBogqobK5vposdDiR52xKBuHuMKHo0LHQcMSJap9bSqES9BbISOW5D9qhcgm2Lbsm3HIOf7k21Hjo7bf9NpMUMbQZQS7yL0B-5bjZqNSFYnoVfGrhTMUnCM3-W4OwA8xqZuXL14jhmocBEVM-sP95G-ysxgnWniWq5OR2xRuelRJv5IocfgylMYTj64O57oLb1C7gnMcrcO_fkpJgGUEWKQb66U-JZghW4DAYljmWvlpCgfcKM7u914l9Qs-3Q2vzkzvZeTo11CfTRAX6ECfNMzGwLLxvdA_nz7eLHrBRIMz9syhPjjzYFnitlK8G2jYawlS6VmOoPAeUgUjHobmaQ9BoodJ7QpLDG789L9seXj2O57KUp3vW2Gp8NeFCHm3auzw9CwVLEn9c7wWQMHNSG22gUBYijyPle_95m_gbBvq_gdAjhwBPb9pwbXP9SCADvtvZUxUIUG7llCsbBT6ShihlTNAzgwOgxV8txEM5Pi9wG3FZdcj90LjipVCz2LiQEnwGhkoY"
  "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwczovL2hhc3VyYS5pby9qd3QvY2xhaW1zIjp7IngtaGFzdXJhLWFsbG93ZWQtcm9sZXMiOlsiYXV0aF93b3JrZXIiXSwieC1oYXN1cmEtZGVmYXVsdC1yb2xlIjoiYXV0aF93b3JrZXIifSwiaWF0IjoxNjY0MjQ3NzE2fQ.F7IMXysrX7jLs5kEekjZenixkNm8KJfzyBo4KplnSqSstWpAh4lTFNhh8Ow0bVzwphhJEPtcLMXZvYlOmwM7RcQ_8zxD-UcLPC8nru9_n-8eWO1ADwffjJ4GM7V78d-iOV3qX_bqk2L6w8Pt9XCZJ-OCvecyv1_4xndFnVO3kgOsCL78tlbw7TjiMKCKKl74Ew5mstUA7FrGolXrDvCwbeM3lHf0UJdXwTj4U18IWyEgvPWVOSJLZMRDCxhBSnKuTCkYbXkyYt_ugBg4_nAimcg116Z1MXDxC2DLK7JXh_0g11HznlUItdh7pvDIGWFQorXNIy1pY09Li6HTXBQH1oAb_wYPvZOl3Gij-P9hJkkELjmIqDlQhG9ccgPtATf62yMN5huc2fpsrqSx0e0B65XC4g8xVlXMHhxpyDrbjJ0hyBwdez5gBMOF5EWl3slzRPrmRtzMiciSPV9l44sOnD0P4-1nyjllL9v0bIPAtt-rK3ZYtKiIp-XJIOjG1jJ4K6J13jBFt5uvqoXLfxKMQSiBhp40jU4Yqjo0C_6lUkpaC5gOF9BTe8JbuDobdBGqK_gr9vJMUrGb4_LROieO6vtj6ts1mG2k3F0rpxuHMwTZIx2DuHUXXswJK7J6OXLjGFi1QjIzukfXmoBplLuqxsqLzOLH6Kxv0_WIjrkLcwA"
  "eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiIzNjgyNDUwYi1jNzliLTRiNjItYTNkOS01YWZkYmQ2ZDM0ZDciLCJpc3MiOiJhdXRoLnhuZnRzLmRldiIsImF1ZCI6ImJhY2twYWNrIiwiaWF0IjoxNjgwNzAyMjY4fQ.Ufx857qRiHE-NdM_olG97818Ouru72fLCEuSoC4huojEOvDfWQwP3MWGomyh6D70J7lASw-XIGR-vlv6wTdO6EdfZFJ7UMCosKoUrWnRZb-JekDBqxwIvKRfl2kEiwrWAZ8XT-3VnEigX6sGn340rVMmzPl87EZ7u6zeb0Sej7yggtGdzK5We7iqRip2ZYkeD2obIGGBdHcmy-XHOeJTVJBvG-F9jPUM6HsVpohCFMsPscJjPuLi0UuqhKBPmZUfSPWRY_VLky8_cvgjU7K7ldl_3xkp0gRgtK7UJfDIJLNbAgOkUFiOOkjn-VFU5zXQYXhXp5RFd8nx9ftQtxBUbQ"
  "eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJiYjNkMGI5NC0xNWYxLTQ2MTAtYTE5OC1lYzFiZjFiZDVhYWMiLCJpc3MiOiJhdXRoLnhuZnRzLmRldiIsImF1ZCI6ImJhY2twYWNrIiwiaWF0IjoxNjgwNzAxNjM4fQ.P2FydtVjmrCFoS31If4nwzj-NHZ1j8CJ4GYcv7A7QiVEZQh4jH3fSk3uZM_OU67GF2u6OG_u_-M6l67aOfdtrkwowCCpk0iEbmB-eSz1oTHg_jgn6qgAzuSw3sStAtqNlOKwdquk2k0NmOvIphHH0_JW-n58WNTUWE2gV41Hs-MN61goE4230DcDYTaVCwkDYs4qjpoOK3AuJ76sYKuxJp78rTc12xtYScSi3s6Lzi1btCOVSID41n7UX9btv1nQxm6UH6HWa5lH5Pb5C8Mqf7RuNg_rrUXC36clzvqLj63A8gLwnGYPNlY1bpDwowy9toUixsBs_X92I4bxl_lOrg"
  "eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJjNzcwOWM3Ni1hYTFhLTRkZmUtODI0Mi03ODZmN2Q2ZThiMTkiLCJpc3MiOiJhdXRoLnhuZnRzLmRldiIsImF1ZCI6ImJhY2twYWNrIiwiaWF0IjoxNjgwNzAxMjk5fQ.HnMEi_acM9uauL-17isLEU97WKctpdv10rvdTvHzd5dfbAbkyqqpJpepwLHRI86nejMxeHYyrNTSN4xk3pyeR1Xc--mj4Z7jHnwBXaV_ZROhAxz3y0koeUS7UaJ5oP7pqzzqC4dux6yUkqYIlpVqUZHrTauswILWGwdjxgAdrxDme81EkR5_QhDqSCfE0GvORto8xOoDHFxLQWWI3LAaXwFpHdfQcowLM_4lJGv-KKU3pPYT41OTCQFFP4JZbb2mkSslSnMu0kUN1NAXIQWf67X1ijogFndss3N4Cm0EUNwGkln1nXh7Gzx98HConrGJSjmeXtqwPSx5P7IBFzDL3w"
  "eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJmYjE0YWIwYy1mMjBmLTRiNWQtYThkOS1mOTQwOWViNjkzODAiLCJpc3MiOiJhdXRoLnhuZnRzLmRldiIsImF1ZCI6ImJhY2twYWNrIiwiaWF0IjoxNjgwNzAyMTAxfQ.ClllrJvRXQZzFKwmJJi_2Ek1JSad2VMugodEq9GEg0D40HNNak7iMLEOfYlaE7uZ6yq5nKIaHm6QUJ7mRbPrWBQq0Zr5GFnzt-16aL3reYAtt_o5ho-fijZ-TAZGL6dGCfJ05zzLMJGH7rjaEXAQkoOceWP6P8_FCdJds2XFraMTNUQzNvrNbsB6f3v2mAnIr1mWYykztWTW-EDzz3Bkpg0sOrccFOjI-rpO1GZ9OclOEuzYRb08WVQVbVsQc6VK0Z8FjE9xWNNPKj4swuNsXEnd3CZdVB4fniyHKVpXQg7QSb5LzBz60ywi9A64c1D7kfZX95zMQlRMoq1qYbD2eA"
)

# ------

THIS_FILE="scripts/check-for-jwts.sh"
POSSIBLE_JWT_REGEX="eyJhbGci" # see https://stackoverflow.com/a/49519717
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM)

for FILE in $STAGED_FILES
do
  # Skip this file as it contains JWTs
  if [ $FILE = $THIS_FILE ]
  then
    continue
  fi

  # -U0 does not generate any context lines.
  # --word-diff=porcelain treats changed words as changed lines
  ADDED_OR_MODIFIED_LINES=$(git diff --cached -U0 --word-diff=porcelain $FILE | grep -e '^+[^+]' )

  for LINE in $ADDED_OR_MODIFIED_LINES
  do
    if echo $LINE | grep -q $POSSIBLE_JWT_REGEX
    then
      IS_ALLOWLISTED=false
      for TERM in "${ALLOWLIST[@]}"
      do
        if echo $LINE | grep -q "$TERM"
        then
          IS_ALLOWLISTED=true
          break
        fi
      done

      if [ "$IS_ALLOWLISTED" = false ]
      then
        echo "\033[31m‚ùåError: '$FILE' might contain one or more JWTs as it includes the string '$POSSIBLE_JWT_REGEX'\033[0m"
        echo "\033[31mPlease check and try again, if it's intentional then add it to the ALLOWLIST in $THIS_FILE\033[0m"
        exit 1
      fi
    fi
  done
done

exit 0
